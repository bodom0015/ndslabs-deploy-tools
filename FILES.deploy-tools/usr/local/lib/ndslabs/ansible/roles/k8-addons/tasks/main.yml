- name: Kube Addons| copy yaml
  copy: src="{{ item }}" dest="/tmp/{{ item }}"
  with_items:
    - kube-system-namespace.yaml
    - kube-dash.yaml
    - kube-ui.yaml
    - elk.yaml
    - grafana.yaml
    - prom-dash.yaml


###########################
#  Namespace: kube-system
###########################
- name: Kube-System status
  command: kubectl get ns kube-system
  ignore_errors: yes
  register: namespace

- name: Kube Addons| create kube-system namespace
  command: kubectl create -f "/tmp/kube-system-namespace.yaml"
  when: namespace.rc != 0



##########################
#   Kubernetes Dashboard
##########################
- name: Kube Dashboard status
  command: kubectl get rc kubedash --namespace=kube-system
  ignore_errors: yes
  register: kubedash

- name: Kube Addons| create kube-dash 
  command: kubectl create -f "/tmp/kube-dash.yaml"
  when: kubedash.rc != 0



######################
#   KubeUI
######################
- name: Kube UI status
  command: kubectl get rc kubernetes-dashboard --namespace=kube-system
  ignore_errors: yes
  register: kubeui

- name: Kube Addons| create kube-ui
  command: kubectl create -f "/tmp/kube-ui.yaml"
  when: kubeui.rc != 0



###########################
#   Prometheus Dashboard
###########################
- name: Prometheus Dashboard status
  command: kubectl get rc kube-prometheus --namespace=kube-system
  ignore_errors: yes
  register: promdash

- name: Kube Addons| create prom-dash
  command: kubectl create -f "/tmp/prom-dash.yaml"
  when: promdash.rc != 0



#######################
#  Logging: ELK
#######################
- name: Elasticsearch status
  command: kubectl get rc elasticsearch-logging-v1 --namespace=kube-system
  ignore_errors: yes
  register: elastic

- name: Kibana status
  command: kubectl get rc kibana-logging-v1 --namespace=kube-system
  ignore_errors: yes
  register: kibana

- name: Kube Addons| create elk
  command: kubectl create -f "/tmp/elk.yaml"
  when: (elastic.rc != 0 or kibana.rc != 0)



##########################
#   Grafana and InfluxDB
##########################
- name: Grafana status
  command: kubectl get rc monitoring-influxdb-grafana-v3 --namespace=kube-system
  ignore_errors: yes
  register: grafana

- name: Heapster status
  command: kubectl get rc heapster-v1.1.0.beta2 --namespace=kube-system
  ignore_errors: yes
  register: heapster

- name: Kube Addons| create grafana
  command: kubectl create -f "/tmp/grafana.yaml"
  when: (grafana.rc != 0 or heapster.rc != 0)
