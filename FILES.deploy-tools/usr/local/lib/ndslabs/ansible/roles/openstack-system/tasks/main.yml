---


- name: OpenStack System
  connection: local
  become: false
  os_server:
    state: present
    wait: yes
    name: "{{ ansible_host }}"
    image: "{{ image }}"
    flavor: "{{ flavor }}"
    key_name: "{{ key_name }}"
    auto_ip: false
  register: os_host

#- debug: var=os_host

- name: Grab Private IP 
  set_fact:
    ansible_ssh_host: "{{ os_host.server.private_v4 }}"
  register: os_priv_addr

- name: Wait for host up
  become: false
  local_action: shell ssh -i {{key_path}}/{{key_name}}.pem -o BatchMode=yes -o StrictHostKeyChecking=no {{ansible_ssh_user}}@{{ansible_ssh_host}} echo "{{ansible_ssh_host}}"
  register: result
  until: result['stdout'] == "{{ansible_ssh_host}}"
  retries: 20
  delay: 15

- name: register key for host
  set_fact:
    ansible_ssh_private_key_file: "{{key_path}}/{{key_name}}.pem"