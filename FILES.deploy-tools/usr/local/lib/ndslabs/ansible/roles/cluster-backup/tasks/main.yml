
# relies on glfs-config-global configmap in cluster from k8-glfs-server-pods
# Run after glfs server and glfs clients are deployed 

- name: Create Backup config template
  template: src=backup-config.j2 dest=/tmp/backup-config

- name: Create Backup config key file
  copy: dest=/tmp/backup-key.pem src=/root/SAVED_AND_SENSITIVE_VOLUME/{{ backup_key }}

- name: Create cluster key file
  copy: dest=/tmp/cluster-key.pem src=/root/SAVED_AND_SENSITIVE_VOLUME/{{ key_name }}.pem

- name: Cluster backup create config secrets
  shell: /opt/bin/kubectl create secret generic backup-config --from-file=/tmp/backup-config --from-file=/tmp/backup-key.pem --from-file=/tmp/cluster-key.pem --namespace=kube-system

- name: Cluster backup deploy spec
  template: src=cluster-backup-ds.j2 dest=/tmp/cluster-backup-ds.yaml

- name: Cluster backup deploy deploy pods
  shell: /opt/bin/kubectl create -f  /tmp/cluster-backup-ds.yaml --namespace=kube-system

