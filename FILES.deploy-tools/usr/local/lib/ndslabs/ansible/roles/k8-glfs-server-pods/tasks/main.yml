
- name: Gluster Server Pods Deploy
  template: src=gluster-server-ds.yaml.j2 dest=/tmp/gluster-server-ds.yaml
  delegate_to: "{{ groups['masters'][0] }}"
  register: deploy
  run_once: true

- name: Gluster Server Pods Deploy
  command: kubectl create -f  /tmp/gluster-server-ds.yaml
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true
  when:  deploy.changed

- name: Gluster Init Cluster get a server pod
  shell: "kubectl get pods --selector=name=glusterfs-server | grep Running | cut -d' ' -f1 | tail -1"
  run_once: true
  delegate_to: "{{ groups['masters'][0] }}"
  register: shellout
  until: shellout.stdout != ""
  retries: 10
  delay: 20

- name: Gluster get server part 2
  set_fact: 
    glpod: "{{ shellout.stdout }}"

- debug: var=glpod

- name: Gluster Init Peer Probe
  command: "kubectl exec -it {{ glpod }} gluster peer probe {{ ansible_ssh_host }}"
  delegate_to: "{{ groups['masters'][0] }}"



#- debug: msg="kubectl exec -it {{ glpod }} gluster volume create" 
#- debug: msg="{{ clusterfs_vol_name }} stripe 2 replica 2 transport tcp "
#- debug: msg="{{ hostvars[groups['glfs'][0]]['ansible_ssh_host'] }}:{{ brick_mount_path }}"
#- debug: msg="{{ groups['glfs'][0]['ansible_ssh_host'] }}:{{ brick_mount_path }}{{ groups['glfs'][f]['ansible_ssh_host'] }}:{{ brick_mount_path }}{{ groups['glfs'][2]['ansible_ssh_host'] }}:{{ brick_mount_path }}{{ groups['glfs'][3]['ansible_ssh_host'] }}:{{ brick_mount_path }}"

- name: Gluster Full Cluster FS Volume 2x2 strip/mirror
  shell: "kubectl exec -it {{ glpod }} gluster volume create {{ clusterfs_vol_name }} stripe 2 replica 2 transport tcp  {{ hostvars[groups['glfs'][0]]['ansible_ssh_host'] }}:{{ brick_mount_path }}/brick {{ hostvars[groups['glfs'][1]]['ansible_ssh_host'] }}:{{ brick_mount_path }}/brick {{ hostvars[groups['glfs'][2]]['ansible_ssh_host'] }}:{{ brick_mount_path }}/brick {{ hostvars[groups['glfs'][3]]['ansible_ssh_host'] }}:{{ brick_mount_path }}/brick && true"
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true

- name: Gluster Start volume
  shell: "kubectl exec -it {{ glpod }} gluster volume start {{ clusterfs_vol_name }} && true"
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true                                                                                                                            

- name: Gluster Global volume check                                                                                                         
  command: "kubectl exec -it {{ glpod }} gluster volume status {{ clusterfs_vol_name }}"                                                    
  delegate_to: "{{ groups['masters'][0] }}"                                                                                                 
  run_once: true                                                                                                                            
