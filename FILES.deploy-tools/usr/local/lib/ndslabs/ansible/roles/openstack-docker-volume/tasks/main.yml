---

- name: OpenStack docker volume
  become: false
  connection: local
  os_volume:
    state: present
    wait: yes
    size: "{{ docker_volume_gb }}"
    display_name: "{{ ansible_host }}-docker-volume"
  register: dockervol

- name: Attach OS volume
  connection: local
  become: false
  os_server_volume:
    state: present
    wait: yes
    server: "{{ ansible_host }}"
    volume: "{{ ansible_host }}-docker-volume"
  register: docker_vol_attach
  when: dockervol.changed

- set_fact:  docker_volume_dev="{{ docker_vol_attach.attachments[0].device }}"
  when: dockervol.changed

- name: Format docker volume
  become: true
  filesystem: fstype=xfs dev="{{ docker_volume_dev }}"
  when: dockervol.changed

- name: create docker volume mount service for systemd
  become: true
  template: src=mount.service.j2 dest=/etc/systemd/system/var-lib-docker.mount
  when: dockervol.changed

- name: notify systemd of config changes
  become: true
  command: systemctl daemon-reload
  when: dockervol.changed

- name: start docker volume mount service and set to start on startup
  become: true
  service: name=var-lib-docker.mount state=started enabled=yes
  when: dockervol.changed



  
