---

- name: OpenStack storage volume
  become: false
  connection: local
  os_volume:
    state: present
    wait: yes
    size: "{{ storage_volume_gb }}"
    display_name: "{{ ansible_host }}-storage-volume"
  register: storagevol

- name: Attach OS volume
  connection: local
  become: false
  os_server_volume:
    state: present
    wait: yes
    server: "{{ ansible_host }}"
    volume: "{{ ansible_host }}-storage-volume"
  register: storage_vol_attach
  when: storagevol.changed

- set_fact:  storage_volume_dev="{{ storage_vol_attach.attachments[0].device }}"
  when: storagevol.changed

- name: Format storage volume
  become: true
  filesystem: fstype=xfs dev="{{ storage_volume_dev }}"
  when: storagevol.changed

- name: create storage volume mount service for systemd
  become: true
  template: src=mount.service.j2 dest="/etc/systemd/system/{{ mount_service_name }}.mount"
  with_items:
    -  { dest: /var/log, src: "{{ storage_volume_dev }}/log", mount_service_name: var-log }
    -  { dest: /var/lib/kubelet, src: "{{ storage_volume_dev }}/kubelet", mount_service_name: var-lib-kubelet }
  when: storagevol.changed
  
- name: start storage volume mount service and set to start on startup
  become: true
  service: name="{{ mount_service_name }}.mount" state=started enabled=yes
  with_items:
    -  { mount_service_name: var-log }
    -  { mount_service_name: var-lib-kubelet }
  when: storagevol.changed

